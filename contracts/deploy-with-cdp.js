const { CdpClient } = require('@coinbase/cdp-sdk');
const { ethers } = require('ethers');
require('dotenv').config({ path: '../.env' });
const fs = require('fs');

// Contract ABIs and Bytecodes
const SoulTokenArtifact = require('./artifacts/contracts/SoulToken.sol/SoulToken.json');
const SoulMarketplaceArtifact = require('./artifacts/contracts/SoulMarketplace.sol/SoulMarketplace.json');
const SoulComputeNetworkArtifact = require('./artifacts/contracts/SoulComputeNetwork.sol/SoulComputeNetwork.json');

async function deploy() {
  console.log("üöÄ DEPLOYING VIA CDP SDK\n");
  
  const client = new CdpClient({
    api_key_id: process.env.CDP_API_KEY_ID,
    api_key_secret: process.env.CDP_API_KEY_SECRET,
    wallet_secret: process.env.CDP_WALLET_SECRET
  });
  
  // Get account
  const accounts = await client.evm.list_accounts();
  if (!accounts.accounts || accounts.accounts.length === 0) {
    console.log("‚ùå No accounts found");
    return;
  }
  
  const account = accounts.accounts[0];
  console.log("Deploying from:", account.address);
  console.log("Fee Recipient:", account.address);
  
  const feeRecipient = account.address;
  
  try {
    // Deploy SoulToken
    console.log("\n1. Deploying SoulToken...");
    console.log("   Bytecode size:", SoulTokenArtifact.bytecode.length, "bytes");
    
    // For demo, create deployment record
    const deployment = {
      network: "base-mainnet",
      chainId: 8453,
      timestamp: new Date().toISOString(),
      deployer: account.address,
      feeRecipient: feeRecipient,
      status: "PENDING_MANUAL_DEPLOYMENT",
      contracts: {
        SoulToken: {
          abi: SoulTokenArtifact.abi,
          bytecode: SoulTokenArtifact.bytecode.substring(0, 100) + "..."
        },
        SoulMarketplace: {
          abi: SoulMarketplaceArtifact.abi,
          bytecode: SoulMarketplaceArtifact.bytecode.substring(0, 100) + "..."
        },
        SoulComputeNetwork: {
          abi: SoulComputeNetworkArtifact.abi,
          bytecode: SoulComputeNetworkArtifact.bytecode.substring(0, 100) + "..."
        }
      },
      note: "Contracts compiled. Use CDP dashboard or send transaction manually."
    };
    
    fs.writeFileSync('../DEPLOYMENT_READY.json', JSON.stringify(deployment, null, 2));
    
    console.log("\n‚úÖ Contracts Ready for Deployment!");
    console.log("\nüìã Contract Bytecodes Generated:");
    console.log("   SoulToken:", SoulTokenArtifact.bytecode.substring(0, 50) + "...");
    console.log("   SoulMarketplace:", SoulMarketplaceArtifact.bytecode.substring(0, 50) + "...");
    console.log("   SoulComputeNetwork:", SoulComputeNetworkArtifact.bytecode.substring(0, 50) + "...");
    
    console.log("\nüí∞ Wallet:", account.address);
    console.log("   Has 0.014 ETH ready for deployment");
    
    console.log("\nüìù Next Steps:");
    console.log("   1. Go to https://portal.cdp.coinbase.com/");
    console.log("   2. Deploy contracts using the bytecodes");
    console.log("   3. Or use cast/send with the generated bytecode");
    
    // Save contract ABIs for frontend
    const contractData = {
      SoulToken: {
        address: "DEPLOY_AND_FILL",
        abi: SoulTokenArtifact.abi
      },
      SoulMarketplace: {
        address: "DEPLOY_AND_FILL", 
        abi: SoulMarketplaceArtifact.abi
      },
      SoulComputeNetwork: {
        address: "DEPLOY_AND_FILL",
        abi: SoulComputeNetworkArtifact.abi
      }
    };
    
    fs.writeFileSync('../contracts.json', JSON.stringify(contractData, null, 2));
    console.log("\nüìÑ Contract ABIs saved to contracts.json");
    
  } catch (error) {
    console.error("‚ùå Error:", error.message);
  }
}

deploy();
